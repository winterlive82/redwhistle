"""
내부자신고 사전상담 시스템 - RAG 지식 베이스
============================================
관련 법률, 비식별 처리된 내부규정, 기신고사례를 포함합니다.
실제 운영 시에는 회사의 내부규정과 사례로 교체합니다.
"""

# ─── 관련 법률 ──────────────────────────────────────────────

LAWS = [
    {
        "id": "law_001",
        "title": "공익신고자 보호법",
        "category": "신고자보호",
        "keywords": ["신고자", "보호", "보복", "불이익", "비밀보장"],
        "content": """
■ 공익신고자 보호법 주요 내용

제1조(목적) 공익을 침해하는 행위를 신고한 사람을 보호하고 지원하는 것을 목적으로 한다.

제2조(공익침해행위) 국민의 건강과 안전, 환경, 소비자의 이익, 공정한 경쟁 및 국민경제를 침해하는 행위.

제8조(신고의 방법)
- 신고자의 이름, 주소, 연락처와 신고 취지·이유·내용을 기재
- 신고 대상과 증거 등을 함께 제출

제12조(비밀보장 의무)
- 누구든지 신고자의 동의 없이 그 인적사항이나 신고 내용을 공개하거나 보도해서는 안 됨
- 위반 시 3년 이하의 징역 또는 3천만원 이하의 벌금

제15조(불이익조치의 금지)
- 신고를 이유로 해고, 징계, 전보, 차별 등 불이익 조치를 해서는 안 됨
- 위반 시 2년 이하의 징역 또는 2천만원 이하의 벌금

제17조(보호조치)
- 불이익조치를 받은 신고자는 위원회에 원상회복이나 보호조치를 신청할 수 있음
- 위원회는 30일 이내에 보호조치 결정
"""
    },
    {
        "id": "law_002",
        "title": "부정청탁 및 금품등 수수의 금지에 관한 법률 (김영란법)",
        "category": "금품수수",
        "keywords": ["금품", "선물", "향응", "뇌물", "청탁", "접대", "식사"],
        "content": """
■ 부정청탁 및 금품등 수수의 금지에 관한 법률 주요 내용

제8조(금품등의 수수 금지)
- 공직자등은 직무 관련 여부를 불문하고 1회 100만원 또는 매 회계연도 300만원을 초과하는 금품등을 수수해서는 안 됨
- 직무와 관련하여 대가성 여부를 불문하고 금품등을 수수해서는 안 됨

제8조제3항(허용되는 금품등)
- 음식물: 3만원 이하
- 선물: 5만원 이하 (농수산물은 10만원)
- 경조사비: 5만원 이하 (화환·조화는 10만원)

제22조(벌칙)
- 1회 100만원 또는 연 300만원 초과 금품 수수: 3년 이하 징역 또는 3천만원 이하 벌금
- 직무 관련 금품 수수: 대가성 입증 시 형사처벌
"""
    },
    {
        "id": "law_003",
        "title": "근로기준법 - 직장 내 괴롭힘 금지",
        "category": "직장내괴롭힘",
        "keywords": ["괴롭힘", "따돌림", "폭언", "부당지시", "업무배제", "왕따"],
        "content": """
■ 근로기준법 제76조의2~3 (직장 내 괴롭힘 금지)

제76조의2(직장 내 괴롭힘의 금지)
- 사용자 또는 근로자는 직장에서의 지위 또는 관계 등의 우위를 이용하여 업무상 적정범위를 넘어 다른 근로자에게 신체적·정신적 고통을 주거나 근무환경을 악화시키는 행위를 하여서는 안 됨

제76조의3(직장 내 괴롭힘 발생 시 조치)
- 누구든지 직장 내 괴롭힘 발생 사실을 알게 된 경우 그 사실을 사용자에게 신고 가능
- 사용자는 신고를 접수하면 지체 없이 조사를 실시
- 피해근로자에게 근무장소 변경, 배치전환, 유급휴가 명령 등 적절한 조치를 취해야 함
- 신고한 근로자에게 해고나 불리한 처우를 해서는 안 됨
"""
    },
    {
        "id": "law_004",
        "title": "개인정보 보호법",
        "category": "정보보안",
        "keywords": ["개인정보", "유출", "반출", "접근권한", "정보보호", "데이터"],
        "content": """
■ 개인정보 보호법 주요 내용

제17조(개인정보의 제공)
- 개인정보처리자는 정보주체의 동의 없이 개인정보를 제3자에게 제공할 수 없음

제29조(안전조치의무)
- 개인정보가 분실·도난·유출·위조·변조 또는 훼손되지 않도록 안전성 확보에 필요한 기술적·관리적 조치를 해야 함

제34조(개인정보 유출 통지 등)
- 개인정보 유출 사실을 알게 되면 지체 없이 정보주체에게 통지해야 함
- 1천명 이상 유출 시 전문기관에도 신고해야 함

제71조(벌칙)
- 개인정보를 부정 이용하거나 제3자에게 제공: 5년 이하 징역 또는 5천만원 이하 벌금
- 정보주체 동의 없이 제공: 5년 이하 징역 또는 5천만원 이하 벌금
"""
    },
    {
        "id": "law_005",
        "title": "중대재해 처벌 등에 관한 법률",
        "category": "안전환경",
        "keywords": ["중대재해", "안전", "사고", "은폐", "산업재해", "사망"],
        "content": """
■ 중대재해 처벌 등에 관한 법률 주요 내용

제2조(정의)
- 중대산업재해: 사망자 1명 이상, 동일 사고로 6개월 이상 치료가 필요한 부상자 2명 이상 등

제4조(사업주 등의 안전 및 보건 확보의무)
- 재해예방에 필요한 인력 및 예산 등 안전보건관리체계의 구축 및 이행
- 재해 발생 시 재발방지 대책의 수립 및 이행

제6조(벌칙)
- 안전보건 확보의무 위반으로 중대산업재해 발생 시: 1년 이상 징역 또는 10억원 이하 벌금
- 사고 은폐 시 가중처벌
"""
    },
    {
        "id": "law_006",
        "title": "전자금융거래법 및 전자금융감독규정",
        "category": "정보보안",
        "keywords": ["전자금융", "해킹", "보안사고", "접근통제", "망분리", "IT보안"],
        "content": """
■ 전자금융거래법 주요 내용

제21조(안전성의 확보의무)
- 금융회사는 전자금융거래의 안전성과 신뢰성을 확보하기 위하여 전자적 전송이나 처리를 위한 인력, 시설, 전자적 장치, 소방시설 등의 정보기술부문에 대해 안전성 확보 조치를 해야 함

제21조의3(전자금융사고 보고)
- 전자금융사고 발생 시 지체 없이 금융위원회에 보고
- 사고 은폐 또는 지연 보고 시 과태료

전자금융감독규정
- 제15조: 접근권한 관리
- 제17조: 내부통제 기준의 수립
- 제37조: 정보처리시스템의 관리
"""
    }
]

# ─── 비식별 처리된 내부규정 (샘플) ─────────────────────────────

INTERNAL_REGULATIONS = [
    {
        "id": "reg_001",
        "title": "임직원 윤리강령",
        "category": "윤리",
        "keywords": ["윤리", "금품", "선물", "이해충돌", "외부활동", "겸직"],
        "content": """
■ 임직원 윤리강령 (비식별 예시)

제5조(이해충돌 방지)
- 임직원은 직무수행 중 개인의 이해와 회사의 이해가 충돌하는 상황을 회피해야 한다.
- 이해충돌이 발생할 우려가 있는 경우 즉시 상급자에게 보고해야 한다.

제12조(금품 수수 금지)
- 거래처, 고객 등 이해관계자로부터 어떠한 명목이든 금품, 향응, 편의를 수수해서는 안 된다.
- 부득이하게 수수한 경우 준법감시인에게 즉시 신고하고 반환 조치해야 한다.
- 허용 범위: 사회통념상 허용되는 3만원 이하의 음식물, 5만원 이하의 선물

제15조(내부정보 이용 금지)
- 직무상 알게 된 미공개 정보를 이용하여 유가증권 거래 등 사적 이익을 추구할 수 없다.
- 퇴직 후에도 재직 중 알게 된 영업비밀을 누설해서는 안 된다.

제20조(신고 의무)
- 임직원은 본 강령 위반 사실을 인지한 경우 신고할 의무가 있다.
- 신고자에 대한 비밀은 철저히 보장하며, 신고를 이유로 불이익을 받지 않는다.
"""
    },
    {
        "id": "reg_002",
        "title": "내부통제기준",
        "category": "내부통제",
        "keywords": ["내부통제", "승인", "결재", "감사", "준법", "보고"],
        "content": """
■ 내부통제기준 (비식별 예시)

제8조(준법감시인의 역할)
- 내부통제기준의 준수 여부를 점검하고 조사한다.
- 내부통제기준 위반 사항 발견 시 대표이사에게 보고한다.

제15조(이상거래 보고)
- 이상거래를 인지한 경우 지체 없이 준법감시인에게 보고해야 한다.
- 보고를 고의로 지연하거나 누락하는 행위는 내부통제기준 위반으로 처리한다.

제22조(내부자신고)
- 내부자신고 대상: 법령 위반, 사규 위반, 부정행위, 비윤리적 행위
- 신고 채널: 사내 익명 신고시스템, 준법감시부서, 외부 헬프라인(레드휘슬)
- 신고자 보호: 신분 비밀 보장, 불이익 금지, 보복 행위자 징계
"""
    },
    {
        "id": "reg_003",
        "title": "정보보호 관리규정",
        "category": "정보보안",
        "keywords": ["정보보호", "보안", "접근권한", "매체", "반출", "암호화"],
        "content": """
■ 정보보호 관리규정 (비식별 예시)

제10조(접근권한 관리)
- 정보시스템 접근권한은 업무 수행에 필요한 최소 범위로 부여한다.
- 접근권한의 부여, 변경, 삭제는 승인 절차를 거쳐야 한다.
- 퇴직, 부서이동 시 즉시 접근권한을 회수해야 한다.

제18조(정보 반출 통제)
- USB, 외장하드 등 이동식 매체를 통한 정보 반출은 승인 절차를 거쳐야 한다.
- 승인 없이 고객정보를 외부로 반출하는 행위는 사규 위반 및 법률 위반이다.
- 이메일, 클라우드 등을 통한 정보 유출도 동일하게 적용한다.

제25조(보안사고 보고)
- 보안사고 인지 시 즉시 정보보호 담당자에게 보고해야 한다.
- 사고 은폐 또는 지연 보고 시 가중 징계한다.
"""
    }
]

# ─── 비식별 처리된 기신고 사례 (샘플) ────────────────────────────

PAST_CASES = [
    {
        "id": "case_001",
        "type": "금품 수수",
        "category": "금품수수",
        "keywords": ["금품", "선물", "거래처", "수수", "접대"],
        "summary": """
[유형] 금품 수수
[정황] 특정 임직원이 주요 거래처 관계자로부터 수백만원 상당의 물품을 반복적으로 수수한 정황
[판단 근거] 사내 윤리강령 제12조(금품 수수 금지) 위반, 부정청탁금지법 제8조 해당
[조사 결과] 위반 인정
[처분] 징계(감봉) 및 거래처 관련 업무에서 배제
[핵심 포인트] 금액 규모에 관계없이 이해관계자로부터의 반복적 금품 수수는 신고 대상
"""
    },
    {
        "id": "case_002",
        "type": "횡령/배임",
        "category": "금품수수",
        "keywords": ["횡령", "배임", "공금", "유용", "착복"],
        "summary": """
[유형] 업무상 횡령
[정황] 특정 임직원이 법인카드를 개인 용도로 반복 사용하고 영수증을 조작한 정황
[판단 근거] 형법 제356조(업무상횡령), 사내 경비 사용 규정 위반
[조사 결과] 위반 인정, 수사기관 고발
[처분] 파면 및 형사 고발
[핵심 포인트] 법인카드 사적 사용은 금액을 불문하고 횡령에 해당할 수 있음
"""
    },
    {
        "id": "case_003",
        "type": "정보보안 위반",
        "category": "정보보안",
        "keywords": ["정보유출", "개인정보", "USB", "반출", "데이터"],
        "summary": """
[유형] 고객 개인정보 무단 반출
[정황] 특정 임직원이 고객정보가 포함된 파일을 승인 없이 개인 이메일로 전송한 정황
[판단 근거] 개인정보보호법 제17조 위반, 정보보호 관리규정 제18조 위반
[조사 결과] 위반 인정, 실제 외부 유출은 확인되지 않음
[처분] 징계(정직) 및 개인정보보호 교육 이수 명령
[핵심 포인트] 유출 의도와 무관하게 승인 없는 개인정보 반출 자체가 위반 행위
"""
    },
    {
        "id": "case_004",
        "type": "직장 내 괴롭힘",
        "category": "직장내괴롭힘",
        "keywords": ["괴롭힘", "폭언", "무시", "따돌림", "업무배제", "모욕"],
        "summary": """
[유형] 직장 내 괴롭힘
[정황] 특정 관리자가 부하직원에게 반복적으로 폭언, 과도한 업무 지시, 회의 참석 배제 등의 행위
[판단 근거] 근로기준법 제76조의2(직장 내 괴롭힘 금지) 해당
[조사 결과] 괴롭힘 인정 (다수 동료 진술 확보)
[처분] 해당 관리자 징계(감봉) 및 보직 변경, 피해자 부서 이동(희망 시)
[핵심 포인트] 반복적·지속적 행위이며 업무상 적정 범위를 넘는 경우 괴롭힘에 해당
"""
    },
    {
        "id": "case_005",
        "type": "내부규정 위반",
        "category": "내부통제",
        "keywords": ["승인", "결재", "우회", "무시", "절차"],
        "summary": """
[유형] 승인 절차 무시
[정황] 특정 부서에서 일정 금액 이상 지출에 대한 승인 절차를 관행적으로 생략
[판단 근거] 내부통제기준 위반, 업무 프로세스 미준수
[조사 결과] 위반 인정, 조직적 관행으로 판단
[처분] 부서장 징계(경고), 전 부서원 재교육, 프로세스 개선
[핵심 포인트] 관행적 위반도 신고 대상이며, 조직적 관행인 경우 더 중요한 신고 사항
"""
    }
]


# ─── 레드휘슬 신고서 양식 ─────────────────────────────────────

REPORT_TEMPLATE = """[신고 유형]
{report_type}

[사건 개요]
{summary}

[발생 시기]
{time_period}

[관련 정황 및 증거]
{evidence}

[위반 의심 법령/규정]
{violations}

[인지 경위]
{how_known}

[기타 참고사항]
{additional_notes}
"""


# ─── 검색 함수 ────────────────────────────────────────────────

def search_knowledge(query: str, top_k: int = 3) -> str:
    """
    키워드 기반으로 관련 법률, 내부규정, 기신고사례를 검색하여
    LLM 컨텍스트용 문자열을 반환합니다.
    """
    query_lower = query.lower()
    results = []

    all_items = [
        *[{"type": "법률", "item": item} for item in LAWS],
        *[{"type": "내부규정", "item": item} for item in INTERNAL_REGULATIONS],
        *[{"type": "기신고사례", "item": item} for item in PAST_CASES],
    ]

    scored_items = []
    for entry in all_items:
        item = entry["item"]
        score = 0
        # keyword matching
        for kw in item.get("keywords", []):
            if kw in query_lower:
                score += 3
        # title matching
        title = item.get("title", item.get("type", ""))
        if any(word in query_lower for word in title.lower().split()):
            score += 2
        # content/summary matching
        content = item.get("content", item.get("summary", ""))
        for word in query_lower.split():
            if len(word) >= 2 and word in content.lower():
                score += 1

        if score > 0:
            scored_items.append((score, entry))

    scored_items.sort(key=lambda x: x[0], reverse=True)
    top_items = scored_items[:top_k]

    context_parts = []
    for _, entry in top_items:
        item = entry["item"]
        source_type = entry["type"]
        title = item.get("title", item.get("type", ""))
        content = item.get("content", item.get("summary", ""))
        context_parts.append(f"[{source_type}] {title}\n{content.strip()}")

    return "\n\n---\n\n".join(context_parts) if context_parts else ""
